<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." name="valide_gml" default="main">
    <taskdef resource="net/sf/antcontrib/antlib.xml"/>
    
    <!-- variabelen definieren -->
    <property name="valid.dir" value="valid"/>
    <property name="check.dir" value="check"/>
    <property name="result.dir" value="result"/>
    <property name="ogr2ogr" value="D:/Apps/QGIS/OSGeo4W64/bin/ogr2ogr.exe"/>
    <property name="src" value="F:/DSO/Geonovum/GitHub/xml_xslt/GML-bestandenBrittBruidschat"/>
    <property name="gfs" value="F:/DSO/Geonovum/GitHub/xml_xslt/GIO_gml/GIO_test.gfs"></property>
    
    <!-- controleeren of gml valide is volgens GIO schema -->
    <target name="xml_valide">
        <xmlvalidate file="">
            <xmlcatalog id="">
                <catalogpath path="F:/DSO/Geonovum/GitLab/1.0.4/bronhouderkoppelvlak/schema/extern/extern-catalog.xml" >
                </catalogpath>
            </xmlcatalog>
        </xmlvalidate>
    </target>
    
    <!-- initialiseren: folders aanmaken -->
    <target name="init" description="initialiseren">
        <delete dir="${src}/${valid.dir}" failonerror="no" includeemptydirs="true"/>
        <mkdir dir="${src}/${valid.dir}"/>
        <echo message="${basedir}"></echo>
        <delete dir="${src}/${check.dir}" failonerror="no" includeemptydirs="true"/>
        <mkdir dir="${src}/${check.dir}"/>
        <delete dir="${src}/${result.dir}" failonerror="no" includeemptydirs="true"/>
        <mkdir dir="${src}/${result.dir}"/>
    </target>
    
    <!-- alle gml bestanden doorlopen en voor elk bestand bron_valideer uitvoeren -->
    <target name="loop">
        <foreach target="bron_valideer" param="file">
            <path id="input">
                <fileset dir="${src}" includes="*.gml"/>
            </path>
        </foreach>
    </target>

    <!-- gml bestand valideren en resultaat in valid folder zetten -->
    <target name="bron_valideer" description="Valideren van bronbestanden">
        <basename property="file.name" file="${file}"/>
        <exec dir="${src}" executable="${ogr2ogr}" failonerror="no">
            <arg line="-f GML"/>
            <arg line="${src}/${valid.dir}/${file.name}"/>
            <arg line="${src}/${file.name}"/>
            <arg line="-oo GFS_TEMPLATE=${gfs}"/>
            <arg line="-dialect sqlite -sql 'select ST_MakeValid(SnapToGrid(geometry,0.001)) as geometry, Naam, id from Locatie'"/>
            <arg line="-dsco PREFIX=geo"/>
            <arg line="-dsco FORMAT=GML3.2"/>
            <arg line="-dsco WRITE_FEATURE_BOUNDED_BY=no"/>
            <arg line="-dsco GML_FEATURE_COLLECTION=NO"/>
            <arg line="-dsco XSISCHEMA=OFF"/>
        </exec>
        <!-- Locaties terugzetten -->
        <echo message="${src}"/>
        <echo message="${valid.dir}"/>
        <echo message="${file.name}"/>
        
        <xslt in="${src}/${file.name}" out="${src}/${result.dir}/${file.name}" style="test.xsl" processor="trax" force="true">
            <param name="src" expression="${src}"/>
            <param name="valid" expression="${valid.dir}"/>
            <param name="file" expression="${file.name}"/>
        </xslt>
        
<!--        <xslt in="${src}/${file.name}" out="${src}/${result.dir}/${file.name}" style="Locaties_vervangen.xsl" processor="trax" force="true">
            <param name="valide" expression="${src}/${valid.dir}"/>
        </xslt>-->
    </target>
     
     <target name="main" depends="init, loop"></target>
</project>