<?xml version="1.0" encoding="utf-8"?>
<project basedir="." name="tpod" default="main">

  <taskdef resource="net/sf/antcontrib/antlib.xml"/>
  <taskdef name="xmltask" classname="com.oopsconsultancy.xmltask.ant.XmlTask" classpath="xmltask.jar"/>

  <property name="input.dir" value="bron"/>
  <property name="output.dir" value="resultaat"/>
  <property name="temp.dir" value="temp"/>
  <property name="work.dir" value="temp"/>

  <!-- initialiseer mappen -->

  <target name="init" description="Initialiseer mappen">
    <delete dir="${output.dir}" failonerror="no" includeemptydirs="true"/>
    <mkdir dir="${output.dir}"/>
    <delete dir="${temp.dir}" failonerror="no" includeemptydirs="true"/>
    <mkdir dir="${temp.dir}"/>
  </target>

  <!-- kopieer bestanden naar resultaat -->

  <target name="copy" description="Kopieer bestanden">
    <copy todir="${output.dir}">
      <fileset dir="${input.dir}"/>
    </copy>
  </target>

  <!-- maak parameters -->

  <path id="input.list">
    <fileset dir="${input.dir}" includes="*.xml *.gml"/>
  </path>
  <path id="basedir" path="${basedir}"/>

  <if>
    <os family="unix"/>
    <then>
      <pathconvert property="base.dir" refid="basedir" dirsep="/" targetos="unix"/>
      <pathconvert property="file.list" refid="input.list" dirsep="/" pathsep=";" targetos="unix"/>
    </then>
    <else>
      <pathconvert property="base.dir" refid="basedir" dirsep="/" targetos="windows">
        <map from="${basedir}" to="file:/${basedir}"/>
      </pathconvert>
      <pathconvert property="file.list" refid="input.list" dirsep="/" pathsep=";" targetos="windows">
        <map from="${basedir}" to="file:/${basedir}"/>
      </pathconvert>
    </else>
  </if>
  

  <target name="index" description="Creëert een index van de soorten bestanden waaruit de dataset bestaat.">
    <xslt in="template.xml" out="${temp.dir}/index.xml" style="index.xsl" processor="trax" force="true">
      <param name="file.list" expression="${file.list}"/>
      <param name="base.dir" expression="${base.dir}"/>
    </xslt>
  </target>

  <target name="guidse" description="Creëert een juiste aantal guids benodigd en verwerkt die in GML-bestanden en referenties.">
    <xmltask source="${temp.dir}/index.xml">
      <call path="index/file[contains(@type,'gml.xml') or contains(@type,'locatie.xml')]">
        <param name="file.name" path="name/text()"/>
        <param name="oldGUID" path="guid/org/text()"/>
        <param name="newGUID" path="guid/new/text()"/>
        <actions>
          <xslt in="${output.dir}/@{file.name}" out="${temp.dir}/@{file.name}" extension=".gml" style="guids.xsl" processor="trax" force="true">
            <param name="oldGUID" expression="@{oldGUID}"/>
            <param name="newGUID" expression="@{newGUID}"/>
          </xslt>
          <copy file="${temp.dir}/@{file.name}" tofile="${output.dir}/@{file.name}"/>
        </actions>
      </call>
    </xmltask>
  </target>

  <target name="guids" description="Creëert een juiste aantal guids benodigd en verwerkt die in GML-bestanden en referenties.">
    <xmltask source="${temp.dir}/index.xml">
      <call path="index/guids/guid">
        <param name="file.name" path="../@gmlfile"/>
        <param name="oldGUID" path="org/text()"/>
        <param name="newGUID" path="new/text()"/>
        <actions>
          <xslt in="${output.dir}/@{file.name}" out="${temp.dir}/@{file.name}" extension=".gml" style="guids.xsl" processor="trax" force="true">
            <param name="oldGUID" expression="@{oldGUID}"/>
            <param name="newGUID" expression="@{newGUID}"/>
          </xslt>
          <copy file="${temp.dir}/@{file.name}" tofile="${output.dir}/@{file.name}"/>
        </actions>
        <param name="file.name2" path="/index/file/guids/guid[org=@{oldGUID}]"/>
        <actions>
          <xslt in="${output.dir}/@{file.name2}" out="${temp.dir}/@{file.name2}" extension=".gml" style="guids.xsl" processor="trax" force="true">
            <param name="oldGUID" expression="@{oldGUID}"/>
            <param name="newGUID" expression="@{newGUID}"/>
          </xslt>
          <copy file="${temp.dir}/@{file.name2}" tofile="${output.dir}/@{file.name2}"/>
        </actions>
      </call>
    </xmltask>
  </target>
  

  <!-- totale transformatie -->

  <target name="main" description="Totale transformatie" depends="init, copy, index, guids"/>

</project>
